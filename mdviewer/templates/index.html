<!doctype html>
<html>
<head>
  <title>Markdown Tree Viewer</title>
  <link rel="icon" href="/static/favicon.ico">
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="/static/pygments.css">

  {% if enable_math %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css" integrity="sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP" crossorigin="anonymous">

    <!-- The loading of KaTeX is deferred to speed up page rendering -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js" integrity="sha384-cMkvdD8LoxVzGF/RPUKAcvmm49FQ0oxwDF3BGKtDXcEc+T1b2N+teh/OJfpU0jr6" crossorigin="anonymous"></script>

    <!-- To automatically render math in text elements, include the auto-render extension: -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"></script>

  {% endif %}
</head>
<body>

    <div id="sidebar">
        {% from "macros.html" import render_tree %}


<ul class="dir-tree">
  <li class="toggle root">
    <span class="dir-label">Root</span>
    <span class="dir-indicator">(+)</span>
    {{ render_tree(tree) }}
  </li>
</ul>

    </div>

    <div id="content">
      <div class="markdown-body">
        <div id="viewer">Select a Markdown file to view</div>
      </div>
    </div>


<script>

const updateIndicators = () => {
  document.querySelectorAll('.dir-tree .toggle').forEach(dir => {
    const children = dir.querySelectorAll(':scope > .nested > .toggle');
    const indicator = dir.querySelector(':scope > .dir-indicator');
    const allExpanded = Array.from(children).every(child => child.classList.contains('active'));
    const anyChild = children.length > 0;

    if (indicator) {
      indicator.textContent = (anyChild && allExpanded) || (!anyChild && dir.classList.contains('active'))
        ? '(-)'
        : '(+)';
    }
  });
};

document.addEventListener('DOMContentLoaded', function () {

  // Clicking dir-label toggles immediate children
  document.querySelectorAll('.dir-tree .dir-label').forEach(label => {
    label.addEventListener('click', function (e) {
      const dir = this.closest('.toggle');
      dir.classList.toggle('active');
      updateIndicators();
      e.stopPropagation();
    });
  });

  // Clicking dir-indicator toggles entire subtree
  document.querySelectorAll('.dir-tree .dir-indicator').forEach(indicator => {
    indicator.addEventListener('click', function (e) {
      const dir = this.closest('.toggle');
      const shouldExpand = !dir.classList.contains('active');

      // Apply to self and all nested .toggle elements
      dir.classList.toggle('active', shouldExpand);
      dir.querySelectorAll('.toggle').forEach(child => {
        child.classList.toggle('active', shouldExpand);
      });

      updateIndicators();
      e.stopPropagation();
    });
  });

  updateIndicators();
});


// Toggle all from the root’s (all) button
document.querySelectorAll('.all-toggle').forEach(btn => {
  btn.addEventListener('click', function (e) {
    e.stopPropagation();
    const root = this.closest('.toggle');
    const shouldExpand = !root.classList.contains('active');

    // Toggle root and all descendants
    root.classList.toggle('active', shouldExpand);
    root.querySelectorAll('.toggle').forEach(t => {
      t.classList.toggle('active', shouldExpand);
    });

    updateIndicators();
  });
});

  // Run once on load to set initial indicators
  updateIndicators();

const genCopyButtons = () => {
  // Select all <pre><code> blocks generated by markdown2
  document.querySelectorAll("pre > code").forEach(codeBlock => {
    const pre = codeBlock.parentNode;

    pre.addEventListener("click", () => {
      const selection = window.getSelection();
      if (selection && selection.toString().length > 0) {
        // User is selecting text — don't copy
        return;
      }
      navigator.clipboard.writeText(codeBlock.innerText).then(() => {
        // Add highlight class
        pre.classList.add("copied");
        // Remove after 1.5 seconds
        setTimeout(() => pre.classList.remove("copied"), 400);
      });
    });
  });
}


  const fetchContent = (fp) => {
    fetch('/content?file=' + encodeURIComponent(fp))
      .then(res => res.text())
      .then(html => {
        document.getElementById('viewer').innerHTML = html;
  {% if enable_math %}
        renderMathInElement(viewer, {
             delimiters: [
               {left: '$$', right: '$$', display: true},
               {left: '\\[', right: '\\]', display: true},
               {left: '$', right: '$', display: false},
               {left: '\\(', right: '\\)', display: false}
             ],
             throwOnError: false });
  {% endif %}
        history.pushState({}, '', '/' + fp);
        document.title = fp;
        genCopyButtons()
      });
  }

filepath={{ filepath|tojson }}
document.querySelectorAll('.file').forEach(el => {
  el.addEventListener('click', () => fetchContent(el.dataset.path))
  });

if (filepath != "") {
fetchContent(filepath);
}
</script>

</body>
</html>
